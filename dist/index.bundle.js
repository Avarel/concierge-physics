!function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.client=t.renderer=void 0;const s=n(3),r=n(2);let o=document.querySelector("#renderCanvas");if(!o)throw"Canvas is not found!";o.focus();var i=prompt("Please enter the server address","ws://127.0.0.1:64209/ws");if("debug"==i){let e=new s.Renderer(o);throw e.scene=e.createScene(),e.start(),"Debug mode"}if(!i||0==i.length)throw alert("A server address is required, please restart the webpage.");var a=prompt("Please enter your name","anthony");if(!a||0==a.length)throw alert("A valid name, please restart the webpage.");t.renderer=new s.Renderer(o),t.renderer.scene=t.renderer.createScene(),t.client=new r.PhysicsSimulationClient(a,i,!0),t.client.connect(),t.renderer.start()},function(e,t){e.exports=BABYLON},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PhysicsSimulationClient=t.PHYSICS_ENGINE_GROUP=t.PHYSICS_ENGINE_NAME=void 0;const s=n(4),r=n(1),o=n(0);function i(e){return new r.Vector2(e.x,e.y)}function a(e){function t(e){return Math.max(0,Math.min(e,255))/255}return new r.Color3(t(e[0]),t(e[1]),t(e[2]))}t.PHYSICS_ENGINE_NAME="physics_engine",t.PHYSICS_ENGINE_GROUP="physics_engine_out";t.PhysicsSimulationClient=class{constructor(e,t,n=!1){this.reconnectInterval=5e3,this.subscribeInterval=5e3,this.url=t,this.name=e,this.reconnect=n}connect(){console.info("Trying to connect to ",this.url),this.socket=new WebSocket(this.url),this.socket.onopen=e=>this.onOpen(e),this.socket.onmessage=e=>this.onReceive(e),this.socket.onerror=e=>console.log(e),this.socket.onclose=e=>this.onClose(e)}send(e){this.socket.send(JSON.stringify(e))}close(e,t){this.socket.close(e,t)}onOpen(e){this.send({operation:"IDENTIFY",name:this.name})}onClose(e){console.warn(e.code,e.reason),clearInterval(this.subscribeHandle),this.reconnect&&(console.warn("Connection closed, reconnecting in",this.reconnectInterval,"ms"),setTimeout(()=>{this.connect()},this.reconnectInterval))}onReceive(e){let t=JSON.parse(e.data);this.processConciergePayload(t)}trySubscribe(){let e=()=>{console.log("Attempting to subscribe to ",t.PHYSICS_ENGINE_GROUP),this.send({operation:"SUBSCRIBE",group:t.PHYSICS_ENGINE_GROUP})};e(),this.subscribeHandle=window.setInterval(e,this.subscribeInterval)}cancelSubscribe(){clearInterval(this.subscribeHandle),this.subscribeHandle=void 0}onSubscribe(){console.log("Subscribed!"),this.send({operation:"MESSAGE",target:{type:"NAME",name:t.PHYSICS_ENGINE_NAME},data:{type:"FETCH_ENTITIES"}})}processConciergePayload(e){switch(e.operation){case"HELLO":this.uuid=e.uuid,this.trySubscribe();break;case"MESSAGE":if(e.origin.name!=t.PHYSICS_ENGINE_NAME)return;this.processPhysicsPayload(e.data);break;case"STATUS":switch(e.code){case s.StatusCode.NO_SUCH_GROUP:e.data==t.PHYSICS_ENGINE_GROUP&&console.error("Group ",t.PHYSICS_ENGINE_GROUP," does not exist on concierge, is the simulation server on?");break;case s.StatusCode.SUBSCRIBED:e.data==t.PHYSICS_ENGINE_GROUP&&(this.cancelSubscribe(),this.onSubscribe());break;case s.StatusCode.UNSUBSCRIBED:e.data==t.PHYSICS_ENGINE_GROUP&&this.trySubscribe()}}}createShape(e,t,n,s,r=1){let c=i(t),l=n.map(i),d=a(s);o.renderer.createPolygon(e,c,l,d,r)}updateShape(e,t){let n=o.renderer.shapes[e];n?n.moveTo(i(t)):console.warn("Shape ",e," not registered with client")}updateColor(e,t){let n=o.renderer.shapes[e];n?n.setColor(a(t)):console.warn("Shape ",e," not registered with client")}processPhysicsPayload(e){switch(e.type){case"ENTITY_DUMP":console.log("Dumping entities!"),o.renderer.clearShapes();for(let t of e.entities)this.createShape(t.id,t.centroid,t.points,t.color);break;case"POSITION_DUMP":for(let t of e.updates)this.updateShape(t.id,t.position);break;case"COLOR_UPDATE":this.updateColor(e.id,e.color);break;default:console.log(e)}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Shape=t.Renderer=void 0;const s=n(1),r=n(1),o=n(0),i=n(2);t.Renderer=class{constructor(e){this.canvas=e,this.shapes={},this.engine=new s.Engine(e,!0)}clearShapes(){var e;for(let t in this.shapes)if(this.shapes.hasOwnProperty(t)){let n=this.shapes[t];null===(e=this.generator)||void 0===e||e.removeShadowCaster(n.mesh),n.mesh.dispose(),delete this.shapes[t]}}createScene(){this.scene&&this.scene.dispose();let e=new s.Scene(this.engine),t=new s.UniversalCamera("UniversalCamera",new s.Vector3(500,800,-100),e);t.setTarget(new s.Vector3(500,0,500)),t.speed=15,t.attachControl(this.canvas,!0),t.keysDownward.push(17),t.keysUpward.push(32),t.keysUp.push(87),t.keysDown.push(83),t.keysLeft.push(65),t.keysRight.push(68);let n=new r.PointLight("light1",new r.Vector3(500,500,500),e);n.intensity=1;let o=e.createDefaultEnvironment({skyboxSize:1050,groundSize:1050,groundShadowLevel:.5,enableGroundShadow:!0});return o.ground.position.set(500,0,500),o.skybox.position.set(500,0,500),o.skybox.isPickable=!1,o.setMainColor(r.Color3.FromHexString("#74b9ff")),this.generator=new r.ShadowGenerator(512,n),e.createDefaultVRExperience({createDeviceOrientationCamera:!1}).enableTeleportation({floorMeshes:[o.ground]}),e}createPolygon(e,t,n,s,r=1){var o;if(this.scene){let i=a.createPolygon(e,t,n,this.scene,s,r);this.shapes[e]=i,null===(o=this.generator)||void 0===o||o.addShadowCaster(i.mesh)}}start(){null==this.scene&&(this.scene=this.createScene());let e=()=>{this.scene?this.scene.render():this.engine.stopRenderLoop(e)};this.engine.runRenderLoop(e),window.addEventListener("resize",()=>{this.engine.resize()})}stop(){this.engine.stopRenderLoop()}};class a{constructor(e,t){this.centroid=e,this.mesh=t}static createPolygon(e,t,n,c,l,d=1){let h=n.map(e=>e.scale(d)),u=new r.PolygonMeshBuilder("polytri",h,c).build(void 0,50);u.position.y+=50;var S=new r.StandardMaterial("myMaterial",c);return S.diffuseColor=l,u.material=S,u.actionManager=new r.ActionManager(c),u.actionManager.registerAction(new s.ExecuteCodeAction(r.ActionManager.OnPickTrigger,(function(){console.log("Clicking on object ",e,"."),o.client.send({operation:"MESSAGE",target:{type:"NAME",name:i.PHYSICS_ENGINE_NAME},data:{type:"TOGGLE_COLOR",id:e}})}))),new a(t,u)}setColor(e){this.mesh.material.diffuseColor=e}moveTo(e){let t=e.subtract(this.centroid),n=new s.Vector3(t.x,0,t.y);this.mesh.position.addInPlace(n),this.centroid.set(e.x,e.y)}}t.Shape=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatusCode=void 0,function(e){e[e.OK=2e3]="OK",e[e.MESSAGE_SENT=2001]="MESSAGE_SENT",e[e.SUBSCRIBED=2002]="SUBSCRIBED",e[e.UNSUBSCRIBED=2003]="UNSUBSCRIBED",e[e.CREATED_GROUP=2004]="CREATED_GROUP",e[e.DELETED_GROUP=2005]="DELETED_GROUP",e[e.BAD=4e3]="BAD",e[e.UNSUPPORTED=4001]="UNSUPPORTED",e[e.PROTOCOL=4002]="PROTOCOL",e[e.GROUP_ALREADY_CREATED=4003]="GROUP_ALREADY_CREATED",e[e.NO_SUCH_NAME=4004]="NO_SUCH_NAME",e[e.NO_SUCH_UUID=4005]="NO_SUCH_UUID",e[e.NO_SUCH_GROUP=4006]="NO_SUCH_GROUP"}(t.StatusCode||(t.StatusCode={}))}]);